services:
  # PostgreSQL Database with pgvector extension
  postgres:
    image: pgvector/pgvector:pg16
    container_name: ai_tutor_db
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: ai_tutor
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      # Only mount init scripts (extensions, langfuse db) - NOT additive migrations
      # Additive migrations (07, 08, 09) are run by the backend after table creation
      - ./backend/migrations/00_init_vector.sql:/docker-entrypoint-initdb.d/00_init_vector.sql:ro
      - ./backend/migrations/00_create_langfuse_db.sql:/docker-entrypoint-initdb.d/00_create_langfuse_db.sql:ro
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis Cache (for app)
  redis:
    image: redis:7-alpine
    container_name: ai_tutor_redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # Neo4j Graph Database (for Graph RAG)
  neo4j:
    image: neo4j:5.15-community
    container_name: ai_tutor_neo4j
    environment:
      - NEO4J_AUTH=neo4j/password
      - NEO4J_PLUGINS=["apoc"]
    ports:
      - "7474:7474" # Browser UI
      - "7687:7687" # Bolt protocol
    volumes:
      - neo4j_data:/data
    healthcheck:
      test: [ "CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:7474 || exit 1" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # Arize Phoenix - RAG Metrics and Evaluation
  phoenix:
    image: arizephoenix/phoenix:latest
    container_name: ai_tutor_phoenix
    ports:
      - "6006:6006" # Phoenix UI
    environment:
      - PHOENIX_WORKING_DIR=/mnt/data
    volumes:
      - phoenix_data:/mnt/data

  # Jaeger - Distributed Tracing for Agent Observability
  jaeger:
    image: jaegertracing/all-in-one:1.53
    container_name: ai_tutor_jaeger
    environment:
      - COLLECTOR_OTLP_ENABLED=true
    ports:
      - "16686:16686" # Jaeger UI
      - "4317:4317" # OTLP gRPC
      - "4318:4318" # OTLP HTTP
    healthcheck:
      test: [ "CMD-SHELL", "wget --spider -q http://localhost:16686 || exit 1" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # ========================================
  # Langfuse v3 Stack
  # ========================================

  # ClickHouse - Analytics database for traces
  clickhouse:
    image: clickhouse/clickhouse-server:24.3
    container_name: ai_tutor_clickhouse
    user: "101:101"
    environment:
      - CLICKHOUSE_DB=default
      - CLICKHOUSE_USER=clickhouse
      - CLICKHOUSE_PASSWORD=clickhouse
    ports:
      - "8123:8123"
      - "9000:9000"
    volumes:
      - clickhouse_data:/var/lib/clickhouse
      - clickhouse_logs:/var/log/clickhouse-server
    healthcheck:
      test: [ "CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8123/ping || exit 1" ]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 5s

  # MinIO - S3-compatible storage for Langfuse
  minio:
    image: minio/minio:latest
    container_name: ai_tutor_minio
    entrypoint: sh
    # Create the 'langfuse' bucket before starting the service
    command: -c 'mkdir -p /data/langfuse && minio server --address ":9000" --console-address ":9001" /data'
    environment:
      - MINIO_ROOT_USER=minio
      - MINIO_ROOT_PASSWORD=miniosecret
    ports:
      - "9090:9000"
      - "9091:9001"
    volumes:
      - minio_data:/data
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://localhost:9000/minio/health/live || exit 1" ]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 5s

  # Redis for Langfuse (with password)
  langfuse-redis:
    image: redis:7
    container_name: ai_tutor_langfuse_redis
    command: >
      --requirepass myredissecret --maxmemory-policy noeviction
    volumes:
      - langfuse_redis_data:/data
    healthcheck:
      test: [ "CMD", "redis-cli", "-a", "myredissecret", "ping" ]
      interval: 3s
      timeout: 10s
      retries: 10

  # Langfuse Worker (processes events asynchronously)
  langfuse-worker:
    image: langfuse/langfuse-worker:3
    container_name: ai_tutor_langfuse_worker
    restart: always
    depends_on:
      postgres:
        condition: service_healthy
      minio:
        condition: service_healthy
      langfuse-redis:
        condition: service_healthy
      clickhouse:
        condition: service_healthy
    environment:
      # Database
      &langfuse-env
      DATABASE_URL: postgresql://postgres:postgres@postgres:5432/langfuse
      # Security
      SALT: langfuse-salt-change-in-production
      ENCRYPTION_KEY: "0000000000000000000000000000000000000000000000000000000000000000"
      # ClickHouse
      CLICKHOUSE_MIGRATION_URL: clickhouse://clickhouse:9000
      CLICKHOUSE_URL: http://clickhouse:8123
      CLICKHOUSE_USER: clickhouse
      CLICKHOUSE_PASSWORD: clickhouse
      CLICKHOUSE_CLUSTER_ENABLED: "false"
      # Redis
      REDIS_HOST: langfuse-redis
      REDIS_PORT: "6379"
      REDIS_AUTH: myredissecret
      # S3/MinIO
      LANGFUSE_S3_EVENT_UPLOAD_BUCKET: langfuse
      LANGFUSE_S3_EVENT_UPLOAD_REGION: auto
      LANGFUSE_S3_EVENT_UPLOAD_ACCESS_KEY_ID: minio
      LANGFUSE_S3_EVENT_UPLOAD_SECRET_ACCESS_KEY: miniosecret
      LANGFUSE_S3_EVENT_UPLOAD_ENDPOINT: http://minio:9000
      LANGFUSE_S3_EVENT_UPLOAD_FORCE_PATH_STYLE: "true"
      LANGFUSE_S3_EVENT_UPLOAD_PREFIX: events/
      LANGFUSE_S3_MEDIA_UPLOAD_BUCKET: langfuse
      LANGFUSE_S3_MEDIA_UPLOAD_REGION: auto
      LANGFUSE_S3_MEDIA_UPLOAD_ACCESS_KEY_ID: minio
      LANGFUSE_S3_MEDIA_UPLOAD_SECRET_ACCESS_KEY: miniosecret
      LANGFUSE_S3_MEDIA_UPLOAD_ENDPOINT: http://minio:9000
      LANGFUSE_S3_MEDIA_UPLOAD_FORCE_PATH_STYLE: "true"
      LANGFUSE_S3_MEDIA_UPLOAD_PREFIX: media/
      # Telemetry
      TELEMETRY_ENABLED: "false"

  # Langfuse Web (UI and API)
  langfuse-web:
    image: langfuse/langfuse:3
    container_name: ai_tutor_langfuse
    restart: always
    depends_on:
      postgres:
        condition: service_healthy
      minio:
        condition: service_healthy
      langfuse-redis:
        condition: service_healthy
      clickhouse:
        condition: service_healthy
      langfuse-worker:
        condition: service_started
    ports:
      - "3001:3000"
    environment:
      <<: *langfuse-env
      NEXTAUTH_URL: http://localhost:3001
      NEXTAUTH_SECRET: langfuse-secret-change-in-production
      AUTH_DISABLE_SIGNUP: "false"
      # Auto-provisioning
      LANGFUSE_INIT_ORG_ID: "ai-tutor-org"
      LANGFUSE_INIT_ORG_NAME: "AI Tutor Organization"
      LANGFUSE_INIT_PROJECT_ID: "ai-tutor-project"
      LANGFUSE_INIT_PROJECT_NAME: "AI Tutor Platform"
      LANGFUSE_INIT_PROJECT_PUBLIC_KEY: "pk-lf-dev"
      LANGFUSE_INIT_PROJECT_SECRET_KEY: "sk-lf-dev"
      LANGFUSE_INIT_USER_EMAIL: "admin@langfuse.com"
      LANGFUSE_INIT_USER_NAME: "Admin User"
      LANGFUSE_INIT_USER_PASSWORD: "password"
    # healthcheck:
    #   test: [ "CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3000/api/public/health || exit 1" ]
    #   interval: 10s
    #   timeout: 10s
    #   retries: 15
    #   start_period: 90s

    # ========================================
    # Application Stack
    # ========================================

    # Backend API
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: ai_tutor_backend
    environment:
      - DEBUG=true
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=ai_tutor
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - SECRET_KEY=dev-secret-key-change-in-production
      - CORS_ORIGINS_STR=*
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - COHERE_API_KEY=${COHERE_API_KEY}
      # OpenTelemetry Configuration
      - OTEL_SERVICE_NAME=ai-tutor-backend
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317
      - OTEL_EXPORTER_OTLP_PROTOCOL=grpc
      # Langfuse LLM Observability
      - LANGFUSE_ENABLED=true
      - LANGFUSE_HOST=http://langfuse-web:3000
      - LANGFUSE_PUBLIC_KEY=${LANGFUSE_PUBLIC_KEY:-pk-lf-dev}
      - LANGFUSE_SECRET_KEY=${LANGFUSE_SECRET_KEY:-sk-lf-dev}
    ports:
      - "8000:8000"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      jaeger:
        condition: service_healthy
      langfuse-web:
        condition: service_started
    volumes:
      - ./backend/app:/app/app
      - ./backend/migrations:/app/migrations

  # Frontend
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: ai_tutor_frontend
    environment:
      - VITE_API_URL=/api/v1
    ports:
      - "3000:3000"
    depends_on:
      - backend
    volumes:
      - ./frontend:/app
      - /app/node_modules

volumes:
  postgres_data:
  redis_data:
  neo4j_data:
  phoenix_data:
  clickhouse_data:
  clickhouse_logs:
  minio_data:
  langfuse_redis_data:
